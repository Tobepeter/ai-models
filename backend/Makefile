.PHONY: help dev docker-dev docker-down build run test fmt vet clean bootstrap swagger

BINARY_NAME=main
MAIN_PATH=./cmd/main.go

# é»˜è®¤ç›®æ ‡
.DEFAULT_GOAL := help

# å¸®åŠ©ä¿¡æ¯
help: ## æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
	@echo "AI Models Backend - å¯ç”¨å‘½ä»¤:"
	@echo ""
	@echo "å¼€å‘ç¯å¢ƒ:"
	@echo "  dev          å¯åŠ¨æœ¬åœ°å¼€å‘ç¯å¢ƒ (Docker + Airçƒ­é‡è½½)"
	@echo "  docker-dev   å¯åŠ¨å®Œæ•´Dockerå¼€å‘ç¯å¢ƒ"
	@echo "  docker-down  åœæ­¢Dockerç¯å¢ƒ"
	@echo ""
	@echo "æ„å»ºå’Œè¿è¡Œ:"
	@echo "  build        æ„å»ºäºŒè¿›åˆ¶æ–‡ä»¶"
	@echo "  run          ç›´æ¥è¿è¡Œåº”ç”¨"
	@echo ""
	@echo "æµ‹è¯•å’Œä»£ç è´¨é‡:"
	@echo "  test         è¿è¡Œæ‰€æœ‰æµ‹è¯•"
	@echo "  test-coverage è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š"
	@echo "  test-clean   æ¸…ç†æµ‹è¯•æ–‡ä»¶"
	@echo "  fmt          æ ¼å¼åŒ–ä»£ç "
	@echo "  vet          é™æ€ä»£ç æ£€æŸ¥"
	@echo ""
	@echo "å·¥å…·:"
	@echo "  bootstrap    å®‰è£…å¼€å‘ä¾èµ– (Air)"
	@echo "  swagger      ç”Ÿæˆ Swagger æ–‡æ¡£"
	@echo "  clean        æ¸…ç†æ„å»ºæ–‡ä»¶"
	@echo ""
	@echo "ä½¿ç”¨ç¤ºä¾‹: make dev"

# NOTE: æŒ‡å®š file åé»˜è®¤ä¸ä¼šåº”ç”¨ docker-compose.override.yml æ–‡ä»¶
dev:
	docker-compose -f docker-compose.yml up -d
	IS_AIR_DEV=true air -c .air.toml

docker-dev:
	@echo "ğŸ³ å¯åŠ¨ Docker å¼€å‘ç¯å¢ƒ..."
	docker-compose up

docker-down:
	docker-compose down

# æ„å»ºå’Œè¿è¡Œ
build:
	go build -o $(BINARY_NAME) $(MAIN_PATH)

run:
	go run $(MAIN_PATH)

# å·¥å…·å‘½ä»¤
test:
	go test -v ./...

fmt: ## æ ¼å¼åŒ–ä»£ç 
	go fmt ./...

vet: ## é™æ€ä»£ç æ£€æŸ¥
	go vet ./...

clean:
	go clean
	rm -f $(BINARY_NAME)

# NOTEï¼šswagä¸èƒ½ç”¨latestï¼Œv1.16.5 æœ‰ä¸€ä¸ª segmentation fault çš„ bug
bootstrap:
	go install github.com/air-verse/air@latest
	go install github.com/swaggo/swag/cmd/swag@v1.8.12

# ç”Ÿæˆ Swagger æ–‡æ¡£
# http://localhost:8080/swagger/index.html#/
swagger:
	swag init -g cmd/main.go -o docs/ --parseDependency --parseInternal
	@echo "Swagger æ–‡æ¡£å·²ç”Ÿæˆåˆ° docs/ ç›®å½•"

# æµ‹è¯•è¦†ç›–ç‡
test-coverage:
	go test -v -coverprofile=coverage.out ./...
	go tool cover -html=coverage.out -o coverage.html
	@echo "è¦†ç›–ç‡æŠ¥å‘Šå·²ç”Ÿæˆ: coverage.html"

# æ¸…ç†æµ‹è¯•æ–‡ä»¶
test-clean:
	rm -f coverage.out coverage.html

